<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Debug Tools</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .test-section h3 {
            color: #333;
            margin-bottom: 15px;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        button:hover {
            background: #0056b3;
        }
        .result {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            margin-top: 10px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .info {
            background: #cce7ff;
            color: #004085;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-right: 10px;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>API Debug Tools</h1>
        <p>Use these tools to diagnose API issues with your Worship Leader application.</p>

        <div class="test-section">
            <h3>1. Basic Server Test</h3>
            <p>Test if your server can execute PHP and return responses.</p>
            <button onclick="testBasicServer()">Test Basic Server</button>
            <div id="basicServerResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. API File Access Test</h3>
            <p>Check if api.php is accessible and responding.</p>
            <button onclick="testApiAccess()">Test API Access</button>
            <div id="apiAccessResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. Database Connection Test</h3>
            <p>Test database connectivity and configuration.</p>
            <button onclick="testDatabaseConnection()">Test Database</button>
            <div id="databaseResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. Authentication Test</h3>
            <p>Test the authentication endpoint with default credentials.</p>
            <div>
                <input type="text" id="testUsername" placeholder="Username" value="admin">
                <input type="password" id="testPassword" placeholder="Password" value="admin123">
                <button onclick="testAuthentication()">Test Login</button>
            </div>
            <div id="authResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. Custom API Test</h3>
            <p>Test any API endpoint with custom parameters.</p>
            <div>
                <select id="testMethod">
                    <option value="GET">GET</option>
                    <option value="POST">POST</option>
                    <option value="PUT">PUT</option>
                    <option value="DELETE">DELETE</option>
                </select>
                <input type="text" id="testEndpoint" placeholder="Endpoint (e.g., songs)" value="test">
                <button onclick="testCustomEndpoint()">Test Endpoint</button>
            </div>
            <div id="customResult" class="result"></div>
        </div>

        <div class="test-section">
            <h3>6. Error Log Check</h3>
            <p>Check for common PHP errors that might cause non-JSON responses.</p>
            <button onclick="checkCommonErrors()">Check Common Issues</button>
            <div id="errorCheckResult" class="result"></div>
        </div>
    </div>

    <script>
        const API_BASE_URL = window.location.origin + window.location.pathname.replace('debug.html', 'api.php');

        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = content;
        }

        async function testBasicServer() {
            const resultEl = 'basicServerResult';
            showResult(resultEl, 'Testing basic server functionality...', 'info');
            
            try {
                // Test with a simple PHP script
                const testContent = `<?php
                header('Content-Type: application/json');
                echo json_encode([
                    'status' => 'success',
                    'message' => 'PHP server is working',
                    'php_version' => phpversion(),
                    'timestamp' => date('Y-m-d H:i:s')
                ]);
                ?>`;
                
                showResult(resultEl, `Server test initiated. Check if you can access:
${window.location.origin}${window.location.pathname.replace('debug.html', 'test_server.php')}

Expected response should be JSON with server info.`, 'info');
                
            } catch (error) {
                showResult(resultEl, `Basic server test failed: ${error.message}`, 'error');
            }
        }

        async function testApiAccess() {
            const resultEl = 'apiAccessResult';
            showResult(resultEl, 'Testing API access...', 'info');
            
            try {
                const response = await fetch(API_BASE_URL);
                const contentType = response.headers.get('content-type');
                const responseText = await response.text();
                
                let result = `API Access Test Results:
Status: ${response.status} ${response.statusText}
Content-Type: ${contentType}
Response length: ${responseText.length} characters

Response preview (first 500 chars):
${responseText.substring(0, 500)}`;

                if (responseText.length > 500) {
                    result += '\n... (truncated)';
                }

                const type = response.ok && contentType?.includes('application/json') ? 'success' : 'error';
                showResult(resultEl, result, type);
                
            } catch (error) {
                showResult(resultEl, `API access failed: ${error.message}`, 'error');
            }
        }

        async function testDatabaseConnection() {
            const resultEl = 'databaseResult';
            showResult(resultEl, 'Testing database connection...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/test`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const contentType = response.headers.get('content-type');
                const responseText = await response.text();
                
                if (contentType?.includes('application/json')) {
                    const data = JSON.parse(responseText);
                    showResult(resultEl, `Database test result:
${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult(resultEl, `Database test failed - Non-JSON response:
${responseText}`, 'error');
                }
                
            } catch (error) {
                showResult(resultEl, `Database test error: ${error.message}`, 'error');
            }
        }

        async function testAuthentication() {
            const resultEl = 'authResult';
            const username = document.getElementById('testUsername').value;
            const password = document.getElementById('testPassword').value;
            
            showResult(resultEl, 'Testing authentication...', 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const contentType = response.headers.get('content-type');
                const responseText = await response.text();
                
                let result = `Authentication Test Results:
Status: ${response.status} ${response.statusText}
Content-Type: ${contentType}

Response:
${responseText}`;

                if (contentType?.includes('application/json')) {
                    try {
                        const data = JSON.parse(responseText);
                        result = `Authentication Test Results:
Status: ${response.status} ${response.statusText}
Success: ${data.success ? 'Yes' : 'No'}

${JSON.stringify(data, null, 2)}`;
                        showResult(resultEl, result, response.ok ? 'success' : 'error');
                    } catch (parseError) {
                        showResult(resultEl, result + `\n\nJSON Parse Error: ${parseError.message}`, 'error');
                    }
                } else {
                    showResult(resultEl, result, 'error');
                }
                
            } catch (error) {
                showResult(resultEl, `Authentication test error: ${error.message}`, 'error');
            }
        }

        async function testCustomEndpoint() {
            const resultEl = 'customResult';
            const method = document.getElementById('testMethod').value;
            const endpoint = document.getElementById('testEndpoint').value;
            
            showResult(resultEl, `Testing ${method} ${endpoint}...`, 'info');
            
            try {
                const response = await fetch(`${API_BASE_URL}/${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const contentType = response.headers.get('content-type');
                const responseText = await response.text();
                
                let result = `Custom Endpoint Test Results:
Method: ${method}
Endpoint: ${endpoint}
Status: ${response.status} ${response.statusText}
Content-Type: ${contentType}

Response:
${responseText}`;

                const type = response.ok && contentType?.includes('application/json') ? 'success' : 'error';
                showResult(resultEl, result, type);
                
            } catch (error) {
                showResult(resultEl, `Custom endpoint test error: ${error.message}`, 'error');
            }
        }

        function checkCommonErrors() {
            const resultEl = 'errorCheckResult';
            
            const commonIssues = `Common Issues That Cause Non-JSON Responses:

1. PHP SYNTAX ERRORS:
   - Missing semicolons
   - Unclosed brackets or quotes
   - Incorrect variable names

2. MISSING FILES:
   - config.php not found
   - database.php not found
   - auth.php not found

3. DATABASE CONNECTION:
   - Wrong database credentials in config.php
   - Database server not running
   - Database/tables don't exist

4. PHP CONFIGURATION:
   - display_errors is ON (should be OFF in production)
   - error_reporting shows warnings/notices
   - Missing PHP extensions (PDO, mysql)

5. SERVER CONFIGURATION:
   - .htaccess issues
   - URL rewriting problems
   - CORS headers missing

6. FILE PERMISSIONS:
   - PHP files not readable
   - Directory permissions incorrect

DEBUGGING STEPS:
1. Check if files exist and are readable
2. Test database connection separately
3. Enable error logging temporarily
4. Check server error logs
5. Test with minimal PHP script first

IMMEDIATE FIXES TO TRY:
1. Add error_reporting(0) at top of api.php
2. Check all file paths are correct
3. Verify database credentials in config.php
4. Make sure all require_once files exist`;

            showResult(resultEl, commonIssues, 'info');
        }

        // Show initial information
        window.onload = function() {
            document.getElementById('basicServerResult').innerHTML = `<div class="info">API Base URL: ${API_BASE_URL}</div>`;
        };
    </script>
</body>
</html>